<project name="Contribute Extra Build Steps" default="version">


	<target name="version">
	
		
	
		<property name="root.folder" value="${basedir}/../../.." />
		<property name="versions.file" value="${basedir}/target/repository/versions.txt" />
		<!-- <property name="versions.file" value="${basedir}/versions.txt" /> -->
		
		<!-- Grab version from dependency p2 
		<get src="${something.p2}/versions.txt" dest="${versions.file}"
							username="${ldap.uname}" password="${ldap.pw}" />
		 -->
		<!-- Add OSEE Version -->
		<pathconvert property="version.bundle.path" setonempty="false">
			<path>
				<fileset dir="${basedir}/target/repository/plugins">
					<include name="org.eclipse.osee.framework.core_*" />
				</fileset>
			</path>
		</pathconvert>
		<basename property="version.bundle.base.path" file="${version.bundle.path}" />
		<propertyregex property="core.version" override="true"
			input="${version.bundle.base.path}" regexp="core_(.*).jar" select="\1"
			casesensitive="false" />

		<echo file="${versions.file}" append="true"
			message="OSEE build (org.eclipse.osee.ote): ${core.version}${line.separator}" />

		<if>
			<available file="${root.folder}/org.eclipse.osee/.git" type="dir"
				property="org.eclipse.osee.present" />
			<then>
				<antcall target="git.revision">
					<param name="param1" value="${root.folder}" />
					<param name="param2" value="org.eclipse.osee" />
				</antcall>
			</then>
		</if>

	</target>

	<target name="git.revision" description="Store git revision in ${repository.version}">
		<exec executable="git" outputproperty="git.branch"
			failifexecutionfails="false" errorproperty="git.error" dir="${param1}/${param2}">
			<arg value="rev-parse" />
			<arg value="--abbrev-ref" />
			<arg value="HEAD" />
		</exec>
		<exec executable="git" outputproperty="git.revision"
			failifexecutionfails="false" errorproperty="git.error" dir="${param1}/${param2}">
			<arg value="log" />
			<arg value="-1" />
			<arg value="--pretty=format:%H,%cd" />
		</exec>
		<condition property="repository.version" value="${git.revision}"
			else="unknown">
			<and>
				<isset property="git.revision" />
				<length string="${git.revision}" trim="yes" length="0" when="greater" />
			</and>
		</condition>

		<echo message="${param2},${git.branch},${repository.version}${line.separator}"
			file="${versions.file}" append="true" />

	</target>

</project>
